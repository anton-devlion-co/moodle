define(["jquery","core/str","core/ajax","theme_boost/popover"],function(t,o,n){let e,a=[],s=[],i=[];function r(t){return t.replace("/","_")}function l(t,o){i.includes(o)||(i.push(o),s.push([t,r(t),o]),a.push(r(t)))}function p(){t(document).on("click",".edit-translation",function(o){o.preventDefault(),o.stopPropagation();let a=t(this),s=a.data("string");n.call([{methodname:"tool_customlang_translation_get_string",args:{identifier:s},done:function(o){var n=JSON.parse(o);!function(o,n,a){let s=o.data("string");t(".edit-translation").popover("dispose"),t(".edit-translation").popover("dispose");let i='<div class="popover popover-translation-block">\n                <div class="arrow"></div>\n                <div class="">\n                    <button type="button" class="close popover-translation-close">&times;</button>\n                    <h3 class="popover-header"></h3>\n                </div>\n                <div class="popover-body"></div>';a||(i+=`\n                    <div class="popover-footer text-center"><button type="button" class="popover-translation-close btn btn-default mr-1">${e[1]}</button><button type="button" class="popover-translation-update btn btn-primary mr-1" data-string="${s}">${e[2]}</button></div>`),i+="</div>";let r=`<div class="popover-translation-wrapper"><div class="popover-translation-string">${n}</div></div>`;t(o).popover({content:r,template:i,placement:"top",title:e[3],html:!0,sanitize:!1}),o.popover("show")}(a,n.string,n.error)},fail:Notification.exception}])}),t(document).on("click",".popover-translation-close",function(o){o.preventDefault(),o.stopPropagation(),t(".edit-translation").popover("dispose")}),t(document).on("click",".popover-translation-update",function(o){o.preventDefault(),o.stopPropagation();let e=t(this).parents(".popover"),a=e.find(".popover-translation-string").html(),s=t(this).data("string");n.call([{methodname:"tool_customlang_translation_update_string",args:{string:a,identifier:s},done:function(t){var o=JSON.parse(t);0==o.error&&(e.find(".popover-body").html(o.response),e.find(".popover-footer").slideUp())},fail:Notification.exception}])})}return{init:function(){o.get_strings([{key:"edit",component:"tool_customlang"},{key:"cancel",component:"tool_customlang"},{key:"update",component:"tool_customlang"},{key:"translate_string",component:"tool_customlang"}]).then(function(o){e=o,t(document).ready(function(){let o=t("body").html().replace(/<(style|script)(\s|.)*?>(\s|.)*?<\/(style|script)>/gim,"");const n=/{((.*?)\/(.*?))}/gm;let a;for(;null!==(a=n.exec(o));){a.index===n.lastIndex&&n.lastIndex++;let s=t(":contains("+a[0]+")");if(0==s.length){let t=new RegExp('(?![aria-label])([a-zA-Z0-9_-]+)="(((?!").)+?){'+a[1]+'}"',"gm"),n=o.match(t);n&&n.length&&n.forEach(t=>{l(a[1],t)})}else{let o=s.filter(":not(:has(*))"),n=s[s.length-1];o.push(n),o.each(function(o,n){if(!t(n).hasClass("addedtrtool_"+r(a[1]))){let o=new RegExp("{"+a[1]+"}","gm"),s=a[0]+'<span class="edit-translation" data-string="'+a[1]+'">'+e[0]+"</span>";t(n).html(t(n).html().replace(o,s)),t(n).addClass("addedtrtool addedtrtool_"+r(a[1]))}})}}s.forEach(function(o){let n=o[2],a=t("["+n+"]:visible");a.length&&a.each(function(n,a){t(a).after('<span class="edit-translation" data-string="'+o[0]+'">'+e[0]+"</span>"),t(a).addClass("addedtrtool addedtrtool_"+o[1])})}),p()})}).catch()}}});